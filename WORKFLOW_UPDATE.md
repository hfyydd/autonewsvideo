# 工作流程更新说明

## ✨ 新增功能

### 1. 文案预览和编辑功能

**问题：**
- 之前直接生成视频，用户无法预览和修改AI生成的文案
- 如果文案不满意，需要重新生成整个视频

**解决方案：**
添加了**步骤3: 文案预览和编辑**，允许用户在生成视频前查看和修改文案。

### 2. 中文字体自动检测

**问题：**
- 图片生成时中文显示为乱码（方框）
- 需要手动下载字体文件

**解决方案：**
智能字体加载系统，自动尝试多种字体源：
1. 配置的字体文件（如果存在）
2. macOS 系统字体（PingFang、黑体等）
3. Linux 系统字体（WenQuanYi、Noto Sans CJK）
4. Windows 系统字体（微软雅黑、黑体）

---

## 📋 新的工作流程

### 步骤 1: 获取新闻
1. 选择 RSS 源分类（科技/财经/国际）
2. 点击"获取新闻"
3. 等待新闻列表加载

### 步骤 2: 选择新闻
1. 浏览获取到的新闻列表
2. 勾选想要制作成视频的新闻
3. 可以使用"全选"或"清空"快捷操作
4. 点击"生成文案预览"

### 步骤 3: 文案预览和编辑 ⭐ **新增**
1. AI 为每条新闻生成标题和要点
2. 在预览区域显示所有文案
3. **可以直接编辑**每条新闻的：
   - 标题（支持多行）
   - 每个要点（支持多行）
4. 修改会实时保存到新闻对象
5. 确认文案无误后，进入下一步

### 步骤 4: 视频设置
1. 选择卡片风格（蓝色/粉色/绿色/紫色）
2. 选择语音类型（中文女声/男声等）
3. 点击"开始生成"

### 步骤 5: 生成进度
1. 生成语音（根据确认后的文案）
2. 生成图片（使用确认后的文案）
3. 合成视频
4. 显示完成信息和视频路径

---

## 🔧 技术改进

### 1. 智能字体加载

**位置：** `services/image_generator.py`

```python
def load_font(font_path: str, size: int, bold: bool = False):
    """加载字体，支持多种回退方案"""
    # 尝试1: 使用配置的字体
    # 尝试2: macOS 系统字体
    # 尝试3: Linux 系统字体
    # 尝试4: Windows 系统字体
    # 最后回退: PIL 默认字体
```

**支持的字体：**
- macOS: PingFang.ttc, STHeiti, Hiragino Sans GB
- Linux: wqy-microhei, NotoSansCJK
- Windows: msyh.ttc (微软雅黑), simhei.ttf (黑体)

### 2. 文案预览界面

**位置：** `main.py` 第 182-222 行

**功能：**
- 为每条新闻创建可编辑的预览卡片
- 标题和要点都使用 `TextField` 组件
- 支持多行输入和自动换行
- 修改会通过 `on_change` 事件实时保存

**UI 特性：**
- 蓝色边框和背景，易于区分
- 显示新闻来源和序号
- 固定高度 150px，内部可滚动

### 3. 流程优化

**之前的流程：**
```
选择新闻 → 点击生成 → AI生成文案 → 生成语音 → 生成图片 → 合成视频
```

**现在的流程：**
```
选择新闻 → 生成文案预览 → 编辑确认文案 → 点击生成 → 生成语音 → 生成图片 → 合成视频
```

**优势：**
- 用户可以在生成视频前审核文案
- 避免因文案不满意而浪费时间重新生成
- 可以手动优化 AI 生成的内容
- 更符合实际使用场景

---

## 🎨 界面变化

### 布局调整

**窗口尺寸：** 保持 1000x750

**步骤区域高度分配：**
- 步骤 1 (获取新闻): ~100px
- 步骤 2 (选择新闻): ~200px (减小到 140px + 按钮)
- 步骤 3 (文案预览): ~210px (新增) ⭐
- 步骤 4 (视频设置): ~90px
- 步骤 5 (生成进度): ~120px

**颜色方案：**
- 步骤 1: 蓝色 (BLUE_50)
- 步骤 2: 绿色 (GREEN_50)
- 步骤 3: 紫色 (PURPLE_50) ⭐
- 步骤 4: 橙色 (ORANGE_50)
- 步骤 5: 青色 (CYAN_50)

---

## 💡 使用建议

### 1. 文案编辑技巧

**标题优化：**
- 保持简洁，建议 15-30 字
- 突出关键信息
- 使用动词开头，增加动态感

**要点优化：**
- 每个要点控制在 30-50 字
- 使用短句，易于理解
- 保持逻辑清晰

### 2. 性能优化

**建议新闻数量：**
- 3-5 条新闻：最佳体验
- 6-10 条新闻：可接受
- 超过 10 条：生成时间较长

**文案生成速度：**
- 有 API Key: 每条约 2-5 秒
- 无 API Key: 使用 Mock 数据，秒级响应

### 3. 常见问题

**Q: 文案预览区域显示不全？**
A: 区域高度固定 150px，内部可滚动，向下滚动查看更多内容。

**Q: 修改文案后忘记是否保存？**
A: 不需要手动保存，所有修改都是实时的，直接点击"开始生成"即可。

**Q: 可以重新生成某条新闻的文案吗？**
A: 目前需要重新点击"生成文案预览"，未来可能添加单条重新生成功能。

**Q: 中文还是显示为方框？**
A: 检查系统是否安装了中文字体，macOS/Windows 默认都有，Linux 可能需要安装：
```bash
# Ubuntu/Debian
sudo apt-get install fonts-wqy-microhei

# Fedora/CentOS
sudo yum install wqy-microhei-fonts
```

---

## 🚀 下一步计划（可选）

- [ ] 添加单条文案重新生成按钮
- [ ] 支持添加/删除要点
- [ ] 文案模板选择（正式/轻松/专业）
- [ ] 文案导出/导入功能
- [ ] AI 参数调节（温度、长度等）

---

## 📝 开发者笔记

### 关键代码位置

**文案生成：** `main.py:144-180` (generate_preview_clicked)
**文案编辑：** `main.py:182-222` (create_preview_card)
**字体加载：** `services/image_generator.py:105-172`
**视频生成：** `main.py:229-318` (已移除文案生成步骤)

### 数据流

```
NewsItem.selected = True (步骤2)
    ↓
generate_preview_clicked() (步骤3)
    ↓
AI 生成 → NewsItem.ai_title, ai_points
    ↓
create_preview_card() → TextField 编辑
    ↓
on_change → 实时更新 NewsItem
    ↓
generate_video_clicked() (步骤4)
    ↓
使用 NewsItem.ai_title, ai_points 生成语音和图片
```

---

## ✅ 测试清单

- [x] 代码导入成功
- [x] 字体加载逻辑正确
- [x] 文案预览界面添加成功
- [x] 视频生成流程调整完成
- [ ] 实际运行测试（需要用户测试）
- [ ] 文案编辑实时保存测试
- [ ] 中文字体显示测试

---

## 📄 相关文档

- [BUGFIX.md](BUGFIX.md) - 历史问题修复记录
- [UI_OPTIMIZATION.md](UI_OPTIMIZATION.md) - UI 优化说明
- [QUICKSTART.md](QUICKSTART.md) - 快速开始指南
- [README.md](README.md) - 项目说明
